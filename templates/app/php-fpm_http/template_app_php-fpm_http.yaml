zabbix_export:
  version: '8.0'
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: 49c77ce207f8478da53e761526d6eca5
      template: 'PHP-FPM by HTTP'
      name: 'PHP-FPM by HTTP'
      description: |
        Get PHP-FPM metrics using the Zabbix HTTP agent.
        
        Generated by official Zabbix template tool "Templator"
      wizard_ready: 'YES'
      readme: |
        ## Overview
        
        This template is developed to monitor the FastCGI Process Manager (PHP-FPM) by Zabbix that work without any external scripts.
        Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.
        
        The template `PHP-FPM by Zabbix agent` - collects metrics by polling PHP-FPM status-page with HTTP agent remotely.
        
        Note that this solution supports HTTPS and redirects.
        
        ## Setup
        
        Note that depending on your OS distribution, the PHP-FPM executable/service name can vary. RHEL-like distributions usually name both process and service as `php-fpm`, while for Debian/Ubuntu based distributions it may include the version, for example: executable name - `php-fpm8.2`, systemd service name - `php8.2-fpm`. Adjust the following instructions accordingly if needed.
        
        1. Open the PHP-FPM configuration file and enable the status page as shown.
          ```
          pm.status_path = /status
          ping.path = /ping
          ```
        
        2. Validate the syntax to ensure it is correct before you reload the service. Replace the `<version>` in the command if needed.
          ```
          $ php-fpm -t
          ```
          or
          ```
          $ php-fpm<version> -t
          ```
        
        3. Reload the `php-fpm` service to make the change active. Replace the `<version>` in the command if needed.
          ```
          $ systemctl reload php-fpm
          ```
          or
          ```
          $ systemctl reload php<version>-fpm
          ```
        
        4. Next, edit the configuration of your web server.
        
        If you use Nginx, edit the configuration file of your Nginx server block (virtual host) and add the location block below it.
          ```
          # Enable php-fpm status page
          location ~ ^/(status|ping)$ {
          ## disable access logging for request if you prefer
          access_log off;
        
          ## Only allow trusted IPs for security, deny everyone else
          # allow 127.0.0.1;
          # allow 1.2.3.4;    # your IP here
          # deny all;
        
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_index index.php;
          include fastcgi_params;
          ## Now the port or socket of the php-fpm pool we want the status of
          fastcgi_pass 127.0.0.1:9000;
          # fastcgi_pass unix:/run/php-fpm/your_socket.sock;
          }
          ```
        If you use Apache, edit the configuration file of the virtual host and add the following location blocks.
          ```
          <LocationMatch "/status">
              Require ip 127.0.0.1
              # Require ip 1.2.3.4    # Your IP here
              # Adjust the path to the socket if needed
              ProxyPass "unix:/run/php-fpm/www.sock|fcgi://localhost/status"
          </LocationMatch>
        
          <LocationMatch "/ping">
              Require ip 127.0.0.1
              # Require ip 1.2.3.4    # Your IP here
              # Adjust the path to the socket if needed
              ProxyPass "unix:/run/php-fpm/www.sock|fcgi://localhost/ping"
          </LocationMatch>
          ```
        5. Check the web server configuration syntax. The command may vary depending on the OS distribution and web server.
          ```
          $ nginx -t
          ```
          or
          ```
          $ httpd -t
          ```
          or
          ```
          $ apachectl configtest
          ```
        
        6. Reload the web server configuration. The command may vary depending on the OS distribution and web server.
          ```
          $ systemctl reload nginx
          ```
          or
          ```
          $ systemctl reload httpd
          ```
          or
          ```
          $ systemctl reload apache2
          ```
        
        7. Verify that the pages are available with these commands.
          ```
          curl -L 127.0.0.1/status
          curl -L 127.0.0.1/ping
          ```
        
        If you use another location of the status/ping pages, don't forget to change the `Status page path/Ping page path` host wizard configuration field.
        
        If you use another web server port or scheme for the location of the PHP-FPM status/ping pages, don't forget to change the host wizard configuration fields `Scheme` and `PHP-FPM port`.
      vendor:
        name: Zabbix
        version: 8.0-1
      groups:
        - name: Templates/Applications
      items:
        - uuid: a03bc5c2dc824b8f970ca1d2b7b4637f
          name: 'Accepted connections per second'
          type: DEPENDENT
          key: php-fpm.conn_accepted.rate
          value_type: FLOAT
          description: 'The number of accepted requests per second.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''accepted conn'']'
            - type: CHANGE_PER_SECOND
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: connections
        - uuid: a9ae24915703483ea95a346c625ed70e
          name: 'Get ping page'
          type: HTTP_AGENT
          key: php-fpm.get_ping
          history: '0'
          value_type: TEXT
          url: '{$PHP_FPM.SCHEME}://{$PHP_FPM.HOST}:{$PHP_FPM.PORT}/{$PHP_FPM.PING.PAGE}'
          retrieve_mode: BOTH
          tags:
            - tag: component
              value: health
        - uuid: b91063d42d4b454089b58e29ee3bdb38
          name: 'Get status page'
          type: HTTP_AGENT
          key: php-fpm.get_status
          history: '0'
          value_type: TEXT
          url: '{$PHP_FPM.SCHEME}://{$PHP_FPM.HOST}:{$PHP_FPM.PORT}/{$PHP_FPM.STATUS.PAGE}?json'
          tags:
            - tag: component
              value: raw
        - uuid: cf2fe31db5084bc5b363ef7d0d691c25
          name: 'Listen queue'
          type: DEPENDENT
          key: php-fpm.listen_queue
          description: 'The current number of connections that have been initiated but not yet accepted.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''listen queue'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: listen-queue
        - uuid: 56876a76bd3a4c6c90b033c19a59f6d1
          name: 'Listen queue, len'
          type: DEPENDENT
          key: php-fpm.listen_queue_len
          description: 'The size of the socket queue of pending connections.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''listen queue len'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: listen-queue
        - uuid: a8829ff906e847c2b97a32b1ded60523
          name: 'Listen queue, max'
          type: DEPENDENT
          key: php-fpm.listen_queue_max
          description: 'The maximum number of requests in the queue of pending connections since this FPM pool was started.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''max listen queue'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: listen-queue
        - uuid: 314c3f19311f47acb93b046ab2625c75
          name: 'Queue usage'
          type: CALCULATED
          key: php-fpm.listen_queue_usage
          value_type: FLOAT
          units: '%'
          params: 'last(//php-fpm.listen_queue)/(last(//php-fpm.listen_queue_len)+(last(//php-fpm.listen_queue_len)=0))*100'
          description: 'The utilization of the queue.'
          tags:
            - tag: component
              value: listen-queue
          triggers:
            - uuid: 1ad5018fb19d4a9cb9e627f964bfd627
              expression: 'min(/PHP-FPM by HTTP/php-fpm.listen_queue_usage,15m) > {$PHP_FPM.QUEUE.WARN.MAX}'
              name: 'PHP-FPM: Queue utilization is high'
              event_name: 'PHP-FPM: Queue utilization is high (over {$PHP_FPM.QUEUE.WARN.MAX}% for 15m)'
              priority: WARNING
              description: |
                The queue for this pool has reached `{$PHP_FPM.QUEUE.WARN.MAX}%` of its maximum capacity. 
                Items in the queue represent the current number of connections that have been initiated on this pool but not yet accepted.
              tags:
                - tag: scope
                  value: performance
        - uuid: dcb11355c5ae4c6ab5f1326aa1c7bbd6
          name: 'Max children reached'
          type: DEPENDENT
          key: php-fpm.max_children
          description: 'The number of times that `pm.max_children` has been reached since the PHP-FPM pool was started.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''max children reached'']'
            - type: SIMPLE_CHANGE
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
        - uuid: 226939bd485a4381a5c0a6d4511acbc3
          name: 'Pool name'
          type: DEPENDENT
          key: php-fpm.name
          value_type: CHAR
          description: 'The name of the current pool.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.pool
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 3h
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
        - uuid: 6a090c078ace46bd958b42225c63f5ca
          name: Ping
          type: DEPENDENT
          key: php-fpm.ping
          valuemap:
            name: 'Service state'
          preprocessing:
            - type: REGEX
              parameters:
                - '{$PHP_FPM.PING.REPLY}($|\r?\n)'
                - '1'
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: php-fpm.get_ping
          tags:
            - tag: component
              value: health
          triggers:
            - uuid: 5dcc607026d24e63b2f099540a5d8e9b
              expression: 'last(/PHP-FPM by HTTP/php-fpm.ping)=0 or nodata(/PHP-FPM by HTTP/php-fpm.ping,3m)=1'
              name: 'PHP-FPM: Service is down'
              priority: HIGH
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: availability
        - uuid: 923243cbb4b647389a38b4788aad3141
          name: 'Processes, active'
          type: DEPENDENT
          key: php-fpm.processes_active
          description: 'The total number of active processes.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''active processes'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: memory
        - uuid: 79402b0cac4d4a409b39db4bf71557d2
          name: 'Processes, idle'
          type: DEPENDENT
          key: php-fpm.processes_idle
          description: 'The total number of idle processes.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''idle processes'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: system
        - uuid: 9632f44f9b2648f299e9f61a39daf92f
          name: 'Processes, max active'
          type: DEPENDENT
          key: php-fpm.processes_max_active
          description: 'The highest value of "active processes" since the PHP-FPM server was started.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''max active processes'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
        - uuid: e69faadd7a9d457e8f56d283871b946a
          name: 'Processes, total'
          type: DEPENDENT
          key: php-fpm.processes_total
          description: 'The total number of server processes currently running.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''total processes'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: system
        - uuid: 084848b2d6bd4b8a88424b1ec9055b0f
          name: 'Process manager'
          type: DEPENDENT
          key: php-fpm.process_manager
          value_type: CHAR
          description: 'The method used by the process manager to control the number of child processes for this pool.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''process manager'']'
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 3h
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
          triggers:
            - uuid: 8cfa50bcea744075954d0a9c8a132330
              expression: 'last(/PHP-FPM by HTTP/php-fpm.process_manager,#1)<>last(/PHP-FPM by HTTP/php-fpm.process_manager,#2)'
              name: 'PHP-FPM: Manager changed'
              event_name: 'PHP-FPM: Manager changed (new value received: {ITEM.VALUE})'
              priority: INFO
              description: 'The PHP-FPM manager has changed. Acknowledge to close the problem manually.'
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: notice
        - uuid: 0dd9e388e2584e0090ed65bab39183f9
          name: 'Slow requests'
          type: DEPENDENT
          key: php-fpm.slow_requests
          description: 'The number of requests that has exceeded your `request_slowlog_timeout` value.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''slow requests'']'
            - type: SIMPLE_CHANGE
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
          triggers:
            - uuid: 63bd00ee25af4b42a37dad1d742c66c0
              expression: 'min(/PHP-FPM by HTTP/php-fpm.slow_requests,#3)>0'
              name: 'PHP-FPM: Detected slow requests'
              priority: WARNING
              description: |
                The PHP-FPM has detected a slow request. 
                The slow request means that it took more time to execute than expected (defined in the configuration of your pool).
              tags:
                - tag: scope
                  value: performance
        - uuid: 9a625629fc0a4222acfefa0409ec1c72
          name: 'Start time'
          type: DEPENDENT
          key: php-fpm.start_time
          units: unixtime
          description: 'The time when this pool was started.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''start time'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
        - uuid: 093024c740b946a0bd6637ba9e3e0dad
          name: Uptime
          type: DEPENDENT
          key: php-fpm.uptime
          units: s
          description: 'It indicates how long has this pool been running.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.[''start since'']'
          master_item:
            key: php-fpm.get_status
          tags:
            - tag: component
              value: application
          triggers:
            - uuid: b44815446b3b464f883f4d0e799b020e
              expression: 'nodata(/PHP-FPM by HTTP/php-fpm.uptime,30m)=1'
              name: 'PHP-FPM: Failed to fetch info data'
              event_name: 'PHP-FPM: Failed to fetch info data (or no data for 30m)'
              priority: INFO
              description: 'Zabbix has not received any data for items for the last 30 minutes.'
              manual_close: 'YES'
              dependencies:
                - name: 'PHP-FPM: Service is down'
                  expression: 'last(/PHP-FPM by HTTP/php-fpm.ping)=0 or nodata(/PHP-FPM by HTTP/php-fpm.ping,3m)=1'
              tags:
                - tag: scope
                  value: notice
            - uuid: 9ed4047bdcd74e649814c5d004ba78c7
              expression: 'last(/PHP-FPM by HTTP/php-fpm.uptime)<10m'
              name: 'PHP-FPM: Pool has been restarted'
              event_name: 'PHP-FPM: Pool has been restarted (uptime < 10m)'
              priority: INFO
              description: 'Uptime is less than 10 minutes.'
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: notice
        - uuid: d49adb58e8bb4453911270e5dce1e03e
          name: Version
          type: DEPENDENT
          key: php-fpm.version
          value_type: CHAR
          description: 'The current version of the PHP. You can get it from the HTTP-Header "X-Powered-By"; it may not work if you have changed the default HTTP-headers.'
          preprocessing:
            - type: REGEX
              parameters:
                - '^[.\s\S]*X-Powered-By: PHP/([.\d]{1,})'
                - \1
              error_handler: DISCARD_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 3h
          master_item:
            key: php-fpm.get_ping
          tags:
            - tag: component
              value: application
          triggers:
            - uuid: d6c891de92c34bdba80a2ba88f975271
              expression: 'last(/PHP-FPM by HTTP/php-fpm.version,#1)<>last(/PHP-FPM by HTTP/php-fpm.version,#2) and length(last(/PHP-FPM by HTTP/php-fpm.version))>0'
              name: 'PHP-FPM: Version has changed'
              event_name: 'PHP-FPM: Version has changed (new version: {ITEM.VALUE})'
              priority: INFO
              description: 'The PHP-FPM version has changed. Acknowledge to close the problem manually.'
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: notice
      tags:
        - tag: class
          value: software
        - tag: target
          value: php-fpm
      macros:
        - macro: '{$PHP_FPM.HOST}'
          value: localhost
          description: 'The hostname or IP address of the PHP-FPM status for a host or container.'
          config:
            type: TEXT
            priority: '3'
            label: Address
            description: 'The hostname or IP address of the PHP-FPM status for a host or container.'
            required: 'YES'
        - macro: '{$PHP_FPM.PING.PAGE}'
          value: ping
          description: 'The path of the PHP-FPM ping page.'
          config:
            type: TEXT
            priority: '5'
            label: 'Ping page path'
            description: 'The path of the PHP-FPM ping page.'
        - macro: '{$PHP_FPM.PING.REPLY}'
          value: pong
          description: 'The expected reply to the ping.'
          config:
            type: TEXT
            priority: '6'
            label: 'Expected ping reply'
            description: 'The expected reply to the ping.'
        - macro: '{$PHP_FPM.PORT}'
          value: '80'
          description: 'The port of the PHP-FPM status host or container.'
          config:
            type: TEXT
            priority: '1'
            label: 'PHP-FPM port'
            description: 'The port of the PHP-FPM status host or container. In the range from 1 to 65535 inclusive.'
            required: 'YES'
            regex: '^-?([0-9]+|(([0-9]+)\.([0-9]+)))$'
        - macro: '{$PHP_FPM.QUEUE.WARN.MAX}'
          value: '80'
          description: 'The maximum percent of the PHP-FPM queue usage for a trigger expression.'
          config:
            type: TEXT
            priority: '7'
            section_name: Thresholds
            label: 'Max queue usage (%)'
            description: 'The maximum percent of the PHP-FPM queue usage for a trigger expression. In the range from 0 to 100 inclusive.'
            regex: '^-?([0-9]+|(([0-9]+)\.([0-9]+)))$'
        - macro: '{$PHP_FPM.SCHEME}'
          value: http
          description: 'Request scheme which may be http or https'
          config:
            type: LIST
            priority: '2'
            label: Scheme
            description: 'Request scheme which may be http or https'
            required: 'YES'
            options:
              - value: http
                text: http
              - value: https
                text: https
        - macro: '{$PHP_FPM.STATUS.PAGE}'
          value: status
          description: 'The path of the PHP-FPM status page.'
          config:
            type: TEXT
            priority: '4'
            label: 'Status page path'
            description: 'The path of the PHP-FPM status page.'
      dashboards:
        - uuid: 3faff0de92724362adda98a08229ef4f
          name: 'PHP-FPM: Overview'
          pages:
            - name: Main
              widgets:
                - type: graph
                  width: '36'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'PHP-FPM by HTTP'
                        name: 'PHP-FPM: Process'
                    - type: STRING
                      name: reference
                      value: AAAAA
                - type: graph
                  x: '36'
                  width: '36'
                  height: '5'
                  fields:
                    - type: GRAPH
                      name: graphid.0
                      value:
                        host: 'PHP-FPM by HTTP'
                        name: 'PHP-FPM: Queue'
                    - type: STRING
                      name: reference
                      value: AAAAB
      valuemaps:
        - uuid: 8e8fa515c14c4ac181db791c2c68c518
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up
  graphs:
    - uuid: 6c69974487f34fea9850ac63fd45adbc
      name: 'PHP-FPM: Process'
      graph_items:
        - color: 199C0D
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.processes_max_active
        - sortorder: '1'
          color: F63100
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.processes_idle
        - sortorder: '2'
          color: 00611C
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.processes_total
        - sortorder: '3'
          color: F7941D
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.processes_active
    - uuid: 250e7f6e07064675872b81a8881f4f31
      name: 'PHP-FPM: Queue'
      graph_items:
        - color: 199C0D
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.listen_queue_len
        - sortorder: '1'
          color: F63100
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.listen_queue
        - sortorder: '2'
          color: 00611C
          item:
            host: 'PHP-FPM by HTTP'
            key: php-fpm.listen_queue_max
